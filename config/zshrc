### Zinit ###
if [[ ! -f $HOME/.zinit/bin/zinit.zsh ]]; then
  print -P "%F{33}▓▒░ %F{220}Installing %F{33}DHARMA%F{220} Initiative Plugin Manager (%F{33}zdharma/zinit%F{220})…%f"
  command mkdir -p "$HOME/.zinit" && command chmod g-rwX "$HOME/.zinit"
  command git clone https://github.com/zdharma/zinit "$HOME/.zinit/bin" && \
    print -P "%F{33}▓▒░ %F{34}Installation successful.%f%b" || \
    print -P "%F{160}▓▒░ The clone has failed.%f%b"
fi

[ ! -f "${HOME}/.zinit/bin/zmodules/Src/zdharma/zplugin.so" ] && source "${HOME}/.zinit/bin/zinit.zsh" && zinit module build
module_path+=( "${HOME}/.zinit/bin/zmodules/Src" )
zmodload zdharma/zplugin
# zpmod source-study

source "${HOME}/.zinit/bin/zinit.zsh"
# zinit self-update
# zinit update
# zinit delete --clean


### Zinit Plugin ###
# zinit ice lucid wait='0' atinit='zpcompinit'
# zinit light zdharma/fast-syntax-highlighting
zinit ice lucid wait='0'
zinit light zsh-users/zsh-syntax-highlighting

# zinit ice lucid wait='0' atload='_zsh_autosuggest_start; zpcompinit; zpcdreplay'
zinit ice wait='0' lucid atload='_zsh_autosuggest_start'
zinit light zsh-users/zsh-autosuggestions
ZSH_AUTOSUGGEST_STRATEGY=(match_prev_cmd) # completion) # history)

zinit ice lucid wait='0'
zinit light zsh-users/zsh-completions

# autoload -Uz _zinit
# (( ${+_comps} )) && _comps[zinit]=_zinit
#
# # Load a few important annexes, without Turbo
# # (this is currently required for annexes)
# zinit light-mode for \
#   zinit-zsh/z-a-rust \
#   zinit-zsh/z-a-as-monitor \
#   zinit-zsh/z-a-patch-dl \
#   zinit-zsh/z-a-bin-gem-node


autoload -Uz vcs_info
zstyle ':vcs_info:*' enable git
zstyle ':vcs_info:*' check-for-changes false
zstyle ':vcs_info:git*' formats '%b'
zstyle ':vcs_info:git*' actionformats '%b (%a)'

### Prompt ###
setopt prompt_subst

function prompt_git() {
  is_dirty() {
    test -n "$(git status --porcelain --ignore-submodules)"
  }
  ref="${vcs_info_msg_0_}"
  if [[ -n "${ref}" ]]; then
    if [[ "${ref/.../}" == "${ref}" ]]; then
      ref="🐙${ref}"
    else
      # detached
      ref="🐙${ref/.../}🔒"
    fi
    ref="%F{008}${ref}%f"
    if is_dirty; then
      ref="${ref} %F{yellow}•%f"
    else
      ref="${ref} %F{green}•%f"
    fi
    # prompt_segment ${color} ${PRIMARY_FG}
    print -Pn "${ref}"
  fi
}

export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init --path)"
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"

export PYENV_VIRTUALENV_DISABLE_PROMPT=1
function _prompt_pyenv() {
  [[ -n ${VIRTUAL_ENV} ]] && echo "🐍%F{yellow}${VIRTUAL_ENV##*/}%f "
}

export GOENV_GOPATH_PREFIX=${HOME}/.go
export GOENV_ROOT="${HOME}/.goenv"
export PATH="${GOENV_ROOT}/bin:$PATH"
eval "$(goenv init -)"
# export PATH="${GOROOT:+${GOROOT}/bin:}${PATH}"
# export PATH="${PATH}${GOPATH:+:${GOPATH}/bin}"

function _prompt_goenv() {
  [[ -f .go-version ]] && export GOENV_VERSION="$(cat .go-version)"
  [[ -n ${GOENV_VERSION} ]] && echo "🐶%F{cyan}${GOENV_VERSION}%f "
}

function preexec() {
  timer=$(date +%s%3N)
}

function precmd() {
  vcs_info
  now=$(date +%s%3N)
  elapsed=$([ ${timer} ] && echo $((${now}-${timer})) || echo 0)
  unset timer

  ms=$((elapsed % 1000))
  s=$((elapsed / 1000 % 60))
  m=$((elapsed / 1000 / 60 % 60))
  h=$((elapsed / 1000 / 60 / 60 % 24))
  d=$((elapsed / 1000 / 60 / 60 / 24))

  exectime=""
  [[ ${d} -gt 0 ]] && exectime="${d}%F{magenta}d%f"
  [[ ${h} -gt 0 || -n ${exectime} ]] && exectime="${exectime}${h}%F{magenta}h%f"
  [[ ${m} -gt 0 || -n ${exectime} ]] && exectime="${exectime}${m}%F{magenta}m%f"
  [[ ${s} -gt 0 || -n ${exectime} ]] && exectime="${exectime}${s}%F{magenta}s%f"
  [[ -z ${exectime} ]] && exectime="${ms}%F{magenta}ms%f"

  PROMPT='👤%F{magenta}%n%f 💻%F{cyan}%m%f 📁%F{white}%~%f $(prompt_git)'$'\n''$(_prompt_goenv)$(_prompt_pyenv)🐈 '
  RPROMPT="%(?.%F{green}✓.%F{red}💀%?)%f ⏳%F{white}${exectime}%f 🕑%F{yellow}%D{%H:%M:%S}%f"
  # ▓▒░ ✗
  # ⚡💎🐳🌟🏄🔥✨👀💾💡🚫❗🔄📣📚📺💨🐣🐛💬🌀🚀🐯👋🏠🔮🧪🤖
  # 🔴🟠🟡🟢🔵🟣
}


setopt SHARE_HISTORY
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000

# REPORTTIME=1
# TMOUT=1
# TRAPALRM() {
#   zle reset-prompt
# }


# bindkey -e
bindkey '^f'  forward-word


### Alias ###
alias ls="ls --color=auto"
alias ssh="ssh -Y -D 0.0.0.0:800$WINDOW "
# alias ssh="ssh -Y -D `ifconfig ens37 | sed -n '2p' | awk '{print $2}'`:800$WINDOW "
